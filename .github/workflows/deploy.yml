name: Deploy React-NextJS Frontend (push to main)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS via SSH (git pull + yarn build on VPS)
        env:
          DEPLOY_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          set -e

          DEPLOY_PATH="/var/www/vhosts/zipsy.co.uk/httpdocs"
          REPO_SSH="git@github.com:sayamk3004/zipsy-reactjs.git"
          BRANCH="main"

          # Setup SSH key on GitHub runner
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

          # Agent forwarding so VPS can use this key to access GitHub
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

          ssh -A -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << EOF
            set -e

            DEPLOY_PATH="${DEPLOY_PATH}"
            REPO_SSH="${REPO_SSH}"
            BRANCH="${BRANCH}"

            echo "=== Go to deploy path ==="
            mkdir -p "\$DEPLOY_PATH"
            cd "\$DEPLOY_PATH"

            echo "=== Ensure GitHub host key on VPS ==="
            mkdir -p ~/.ssh
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

            if [ ! -d ".git" ]; then
              echo "=== Not a git repo here; cloning ==="
              # If folder is not empty, clone into a subfolder instead of failing
              if [ -n "\$(ls -A 2>/dev/null)" ]; then
                echo "Directory not empty. Cloning into ./app"
                mkdir -p app
                cd app
              fi
              git clone "\$REPO_SSH" .
            fi

            echo "=== Update repo ==="
            git pull origin main
            git fetch origin
            git checkout "\$BRANCH"
            git reset --hard "origin/\$BRANCH"

            echo "=== Install deps (Yarn) ==="
            if command -v yarn >/dev/null 2>&1; then
              if [ -f yarn.lock ]; then
                yarn install --frozen-lockfile
              else
                yarn install
              fi
            else
              echo "Yarn not found on server. Install it (recommended: enable corepack) and re-run."
              exit 1
            fi

            echo "=== Build ==="
            yarn build

            echo "=== Restart app (optional) ==="
            # Uncomment ONE of these depending on how you run Next.js:
            # pm2 restart zipsy-reactjs || pm2 restart all || true
            # systemctl restart your-service-name || true

            echo "=== Deploy finished ==="
          EOF
